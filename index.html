<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minsu GPT â€” ê°œì„ ëœ UI</title>
<style>
  :root{
    --bg:#ffffff; --text:#111; --muted:#7a7a7a;
    --input-bg:#f2f3f5; --panel:#fafafa;
    --border:#dcdcdc; --accent:#000;
    --radius:14px; --transition:200ms;
  }
  body.dark{ --bg:#0d0d0d; --text:#e8e8e8; --muted:#b5b5b5; --input-bg:#121214; --panel:#161618; --border:#2a2a2a; --accent:#fff; }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased;}
  nav{
    position:fixed; top:0; left:0; right:0; height:60px;
    display:flex; align-items:center; justify-content:space-between;
    padding:0 14px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,0.85), transparent);
    backdrop-filter: blur(6px); z-index:40;
  }
  .logo{ font-weight:700; font-size:18px; letter-spacing:0.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60%; }
  .actions{ display:flex; gap:8px; align-items:center; }
  .actions button{ border:1px solid var(--border); background:transparent; padding:6px 10px; border-radius:999px; cursor:pointer; font-size:14px; }
  .login{ background:var(--accent); color:var(--bg); border:none; }
  .dark-toggle{ width:40px; height:40px; border-radius:10px; display:inline-grid; place-items:center; }

  main{ padding:72px 16px 120px; height:100vh; overflow:auto; display:flex; flex-direction:column; align-items:center; gap:18px; }

  #title{ margin-top:44px; font-size:28px; font-weight:700; text-align:center; transition:opacity var(--transition); color:var(--text); }
  .suggestions{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; width:100%; max-width:900px; margin-top:8px; }
  .suggestion-card{ background:var(--panel); border:1px solid var(--border); padding:12px; border-radius:12px; cursor:pointer; font-size:14px; display:flex; gap:8px; align-items:flex-start; }
  .suggestion-card:hover{ transform:translateY(-4px); transition:transform var(--transition); box-shadow:0 8px 24px rgba(0,0,0,0.06); }

  .chat-wrap{ width:100%; max-width:900px; display:flex; flex-direction:column; gap:10px; }
  .messages{ display:flex; flex-direction:column; gap:10px; }

  /* ë©”ì‹œì§€ ë²„ë¸” */
  .message{ max-width:78%; padding:10px 12px; border-radius:14px; word-break:break-word; white-space:pre-wrap; position:relative; }
  .message.user{ align-self:flex-end; background:var(--accent); color:var(--bg); font-weight:400; /* ì‚¬ìš©ìê°€ ë³´ë‚¸ ë©”ì‹œì§€ ë³¼ë“œ í•´ì œ */ }
  .message.bot{ align-self:flex-start; background:var(--panel); border:1px solid var(--border); color:var(--text); font-size:15px; }

  /* ë´‡ ë‚´ë¶€ - í° í…ìŠ¤íŠ¸ */
  .bot .big{ display:block; font-size:20px; font-weight:700; margin-bottom:8px; }

  /* ì½”ë“œ í‘œì‹œ - ë‚´ë¶€ ì°½ */
  .code-box{ background: #0f1724; color:#e6eef8; border-radius:10px; padding:10px; margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; position:relative; overflow:auto; }
  .code-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding-bottom:8px; color:var(--muted); font-size:13px; }
  .code-lang{ font-weight:600; font-size:13px; color:#e6eef8; opacity:0.85; }
  .copy-btn{ background:transparent; border:1px solid rgba(255,255,255,0.08); color:inherit; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:13px; }

  /* assistant code color in light theme */
  body:not(.dark) .code-box{ background:#f3f5f7; color:#0b1220; }
  body:not(.dark) .code-header{ color:var(--muted); }
  body:not(.dark) .copy-btn{ border:1px solid rgba(0,0,0,0.06); }

  /* loading bubble */
  .loading { display:flex; gap:10px; align-items:center; }
  .loading .dots span{ display:inline-block; width:6px; height:6px; background:var(--muted); border-radius:50%; margin:0 2px; opacity:0.6; animation:blink 1s infinite; }
  .loading .dots span:nth-child(2){ animation-delay:0.15s } .loading .dots span:nth-child(3){ animation-delay:0.3s }
  @keyframes blink{ 0%,100%{opacity:0.2} 50%{opacity:1} }

  /* message controls */
  .msg-controls{ position:absolute; top:6px; right:8px; display:flex; gap:6px; opacity:0; transition:opacity var(--transition); }
  .message:hover .msg-controls{ opacity:1; }
  .ctrl-btn{ background:transparent; border:none; cursor:pointer; font-size:13px; padding:6px; border-radius:8px; color:var(--muted); }

  /* input bar (Gemini-ish) */
  .input-bar{ position:fixed; left:0; right:0; bottom:0; padding:12px; display:flex; justify-content:center; z-index:50; background:linear-gradient(0deg, rgba(0,0,0,0.04), transparent); }
  .input-panel{ width:100%; max-width:900px; display:flex; gap:10px; align-items:flex-end; background:var(--input-bg); border-radius:16px; padding:10px; border:1px solid var(--border); box-shadow:0 6px 18px rgba(0,0,0,0.05); }
  .left-icons{ display:flex; gap:8px; align-items:center; }
  .attach-btn, .plus-btn{ width:44px; height:44px; border-radius:10px; display:grid; place-items:center; cursor:pointer; border:1px solid var(--border); background:transparent; }
  .text-area{ flex:1; min-height:46px; max-height:180px; padding:8px 10px; border-radius:10px; resize:none; border:none; outline:none; background:transparent; color:var(--text); font-size:15px; }
  .send-btn{ width:56px; height:46px; border-radius:12px; border:none; cursor:pointer; display:grid; place-items:center; font-weight:700; background:var(--accent); color:var(--bg); }

  /* attachment preview */
  .attachments{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .attach-item{ background:var(--panel); border:1px solid var(--border); padding:6px 8px; border-radius:10px; font-size:13px; display:flex; gap:8px; align-items:center; }

  /* previous reply modal */
  .prev-modal{ position:fixed; inset:0; display:none; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:70; }
  .prev-card{ width:92%; max-width:760px; background:var(--bg); border-radius:12px; padding:16px; border:1px solid var(--border); max-height:80vh; overflow:auto; }

  /* responsive tweaks */
  @media(max-width:900px){ .suggestions{ grid-template-columns:repeat(2,1fr) } }
  @media(max-width:700px){
    .suggestions{ grid-template-columns:repeat(2,1fr); gap:10px; }
    .logo{ font-size:14px; } /* ëª¨ë°”ì¼ì—ì„œ ì¤„ë°”ê¿ˆ ë°©ì§€: ê¸€ìì¶•ì†Œ */
    #title{ font-size:20px; margin-top:60px; }
  }
</style>
</head>
<body>
<nav>
  <div class="logo" id="logo">Minsu GPT</div>
  <div class="actions">
    <button class="login">ë¡œê·¸ì¸</button>
    <button class="signup">ë¬´ë£Œë¡œ íšŒì› ê°€ì…</button>
    <button class="dark-toggle" id="darkBtn">ğŸŒ™</button>
  </div>
</nav>

<main>
  <h1 id="title">ì–´ë””ì„œë¶€í„° ì‹œì‘í• ê¹Œìš”?</h1>

  <div class="suggestions" aria-hidden="false">
    <div class="suggestion-card" data-prompt="âœï¸ ì°½ì˜ì ì¸ ê¸€ì“°ê¸° ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•´ì¤˜">âœï¸ ì°½ì˜ì ì¸ ê¸€ì“°ê¸° ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•´ì¤˜</div>
    <div class="suggestion-card" data-prompt="ğŸ® íŒŒì´ì¬ìœ¼ë¡œ ê°„ë‹¨í•œ ê²Œì„ ë§Œë“œëŠ” ë²• ì•Œë ¤ì¤˜">ğŸ® íŒŒì´ì¬ìœ¼ë¡œ ê°„ë‹¨í•œ ê²Œì„ ë§Œë“œëŠ” ë²• ì•Œë ¤ì¤˜</div>
    <div class="suggestion-card" data-prompt="â° íš¨ê³¼ì ì¸ ì‹œê°„ ê´€ë¦¬ ë°©ë²• ì¶”ì²œí•´ì¤˜">â° íš¨ê³¼ì ì¸ ì‹œê°„ ê´€ë¦¬ ë°©ë²• ì¶”ì²œí•´ì¤˜</div>
    <div class="suggestion-card" data-prompt="ğŸ”¬ ì¬ë¯¸ìˆëŠ” ê³¼í•™ ì‚¬ì‹¤ ì•Œë ¤ì¤˜">ğŸ”¬ ì¬ë¯¸ìˆëŠ” ê³¼í•™ ì‚¬ì‹¤ ì•Œë ¤ì¤˜</div>
  </div>

  <div class="chat-wrap">
    <div class="messages" id="messages" role="log" aria-live="polite"></div>
  </div>
</main>

<div class="input-bar">
  <div class="input-panel" role="region" aria-label="ë©”ì‹œì§€ ì…ë ¥">
    <div class="left-icons">
      <button class="plus-btn" id="plusBtn" title="ë”ë³´ê¸°">ï¼‹</button>
      <label class="attach-btn" for="fileInput" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</label>
      <input id="fileInput" type="file" multiple style="display:none" />
    </div>

    <textarea id="userInput" class="text-area" placeholder="Geminiì—ê²Œ ë¬¼ì–´ë³´ê¸° â€” ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Shift+Enter ì¤„ë°”ê¿ˆ)" rows="1"></textarea>

    <button id="sendBtn" class="send-btn" title="ë³´ë‚´ê¸°">â¤</button>
  </div>

  <div style="max-width:900px;width:100%;margin-top:8px;">
    <div class="attachments" id="attachments"></div>
  </div>
</div>

<!-- ì´ì „ ë‹µë³€ ëª¨ë‹¬ -->
<div class="prev-modal" id="prevModal">
  <div class="prev-card" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <strong>ì´ì „ ë‹µë³€</strong>
      <button id="closePrev" class="ctrl-btn">ë‹«ê¸° âœ•</button>
    </div>
    <div id="prevContent"></div>
  </div>
</div>

<script>
/* ------------- ì„¤ì •: ë°±ì—”ë“œ ì£¼ì†Œ ------------- */
const BACKEND_URL = 'https://jaewons0227.pythonanywhere.com/ask'; // ê¸°ì¡´ URL ì‚¬ìš©
const BACKEND_FILE_URL = BACKEND_URL; // íŒŒì¼ë„ ê°™ì€ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³´ëƒ„ (ë°±ì—”ë“œê°€ multipart ì²˜ë¦¬ í•„ìš”)

/* ------------- ìƒíƒœ ê´€ë¦¬ ------------- */
// ë©”ì‹œì§€ ê°ì²´ êµ¬ì¡° ì˜ˆì‹œ:
// { id, role: 'user'|'bot', text, attachments: [FileMeta], replies: [replyObj], timestamp }
// replyObj: { id, text, createdAt }
let messagesState = []; // ëª¨ë“  ë©”ì‹œì§€(ì‚¬ìš©ì+ë´‡)
let replyHistory = {}; // messageId -> array of previous replies (most recent last)
const messagesEl = document.getElementById('messages');

let loadingBubble = null;

/* ------------- ìœ í‹¸ ------------- */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

/* ------------- DOM ë Œë”ë§ ------------- */
function renderMessages(){
  messagesEl.innerHTML = '';
  for(const msg of messagesState){
    const el = document.createElement('div');
    el.className = 'message ' + (msg.role === 'user' ? 'user' : 'bot');
    el.dataset.id = msg.id;

    // ì»¨í…ì¸ : ì‚¬ìš©ì/ë´‡ ë‹¤ë¥´ê²Œ ë Œë”ë§
    if(msg.role === 'user'){
      // ì‚¬ìš©ì ë©”ì‹œì§€ (í¸ì§‘ ê°€ëŠ¥)
      const textDiv = document.createElement('div');
      textDiv.className = 'user-text';
      textDiv.innerText = msg.text;
      el.appendChild(textDiv);

      // controls: edit
      const ctrl = document.createElement('div');
      ctrl.className = 'msg-controls';
      const editBtn = document.createElement('button');
      editBtn.className = 'ctrl-btn'; editBtn.title='ìˆ˜ì •'; editBtn.innerText='ìˆ˜ì •';
      editBtn.onclick = ()=> startEditMessage(msg.id);
      ctrl.appendChild(editBtn);
      el.appendChild(ctrl);

      // attachments (if any)
      if(msg.attachments && msg.attachments.length){
        const attachWrap = document.createElement('div');
        attachWrap.style.marginTop='8px'; attachWrap.style.display='flex'; attachWrap.style.flexDirection='column'; attachWrap.style.gap='6px';
        msg.attachments.forEach(a=>{
          const ai = document.createElement('div');
          ai.className='attach-item';
          ai.innerHTML = `<span style="font-weight:600">${escapeHtml(a.name)}</span> <span style="opacity:.7;font-size:13px">(${a.sizeHuman})</span>`;
          attachWrap.appendChild(ai);
        });
        el.appendChild(attachWrap);
      }
    } else {
      // ë´‡ ë©”ì‹œì§€: í…ìŠ¤íŠ¸ì—ì„œ ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´/í¬ë§· í•´ì„
      // í¬ë§· ê·œì¹™ (ê°„ë‹¨ íŒŒì„œ):
      // - ```lang\ncode\n``` => ì½”ë“œ ë°•ìŠ¤
      // - ë¼ì¸ ì‹œì‘ì— "# " => í° ê¸€ì”¨(block .big)
      // - **bold** => <strong>
      const contentWrap = document.createElement('div');
      contentWrap.className = 'bot-content';
      const parts = parseBotText(msg.text);
      parts.forEach(p=>{
        if(p.type==='text'){
          const div = document.createElement('div'); div.innerHTML = p.html;
          contentWrap.appendChild(div);
        } else if(p.type==='big'){
          const d = document.createElement('div'); d.className='big'; d.innerHTML = p.html; contentWrap.appendChild(d);
        } else if(p.type==='code'){
          const cb = document.createElement('div'); cb.className='code-box';
          const header = document.createElement('div'); header.className='code-header';
          const langSpan = document.createElement('div'); langSpan.className='code-lang'; langSpan.innerText = p.lang || 'code';
          const headerRight = document.createElement('div');
          const copyBtn = document.createElement('button'); copyBtn.className='copy-btn'; copyBtn.innerText='ë³µì‚¬';
          copyBtn.onclick = ()=> {
            navigator.clipboard.writeText(p.code).then(()=> copyBtn.innerText='ë³µì‚¬ë¨').catch(()=> copyBtn.innerText='ì—ëŸ¬');
            setTimeout(()=>copyBtn.innerText='ë³µì‚¬',1200);
          };
          headerRight.appendChild(copyBtn);
          header.appendChild(langSpan); header.appendChild(headerRight);
          const pre = document.createElement('pre'); pre.style.margin='0'; pre.style.whiteSpace='pre-wrap';
          pre.textContent = p.code;
          cb.appendChild(header); cb.appendChild(pre);
          contentWrap.appendChild(cb);
        }
      });
      el.appendChild(contentWrap);

      // ì•„ë˜ì— 'ì´ì „ ë‹µë³€' ë²„íŠ¼ ì¶”ê°€ (if history exists)
      const controlsWrap = document.createElement('div'); controlsWrap.style.marginTop='8px';
      const prevBtn = document.createElement('button'); prevBtn.className='ctrl-btn'; prevBtn.innerText='Previous'; prevBtn.onclick = ()=> showPreviousReplies(msg.sourceUserId);
      controlsWrap.appendChild(prevBtn);
      el.appendChild(controlsWrap);
    }

    messagesEl.appendChild(el);
  }
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ê°„ë‹¨í•œ íŒŒì„œ: code blocks, heading(# ), bold */
function parseBotText(text){
  const out = [];
  let remaining = text;
  const codeRegex = /```(\w+)?\n([\s\S]*?)```/m;
  while(true){
    const m = remaining.match(codeRegex);
    if(!m) break;
    const idx = m.index;
    if(idx>0){
      const before = remaining.slice(0, idx);
      out.push(...parseInline(before));
    }
    out.push({type:'code', lang: m[1]||'code', code: m[2]});
    remaining = remaining.slice(idx + m[0].length);
  }
  if(remaining.trim().length) out.push(...parseInline(remaining));
  return out;
}
function parseInline(text){
  // split lines; if a line starts with "# " => big
  const lines = text.split(/\n/);
  const res=[];
  for(const line of lines){
    if(line.startsWith('# ')){
      const html = inlineFormat(escapeHtml(line.slice(2)));
      res.push({type:'big', html});
    } else {
      const html = inlineFormat(escapeHtml(line));
      res.push({type:'text', html});
    }
  }
  // preserve newlines by joining with <br>
  const merged = [];
  let bufferHtml = '';
  for(const r of res){
    if(r.type==='text'){
      bufferHtml += (bufferHtml?'<br/>':'') + r.html;
    } else {
      if(bufferHtml) merged.push({type:'text', html:bufferHtml});
      merged.push(r);
      bufferHtml = '';
    }
  }
  if(bufferHtml) merged.push({type:'text', html:bufferHtml});
  return merged;
}
function inlineFormat(s){
  // **bold**
  return s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
}

/* ------------- ë©”ì„¸ì§€ ìƒì„±/ì „ì†¡ ë¡œì§ ------------- */
function addUserMessage(text, filesMeta=[]){
  const id = uid('msg');
  const msg = { id, role:'user', text, attachments: filesMeta.slice(), timestamp:Date.now() };
  messagesState.push(msg);
  // ì´ˆê¸° reply history for this user message
  replyHistory[id] = [];
  renderMessages();
  return id;
}
function addBotReply(userMsgId, replyText){
  const id = uid('reply');
  const botMsg = { id, role:'bot', text: replyText, timestamp:Date.now(), sourceUserId: userMsgId };
  messagesState.push(botMsg);
  // push into reply history for that user message
  if(!replyHistory[userMsgId]) replyHistory[userMsgId]=[];
  replyHistory[userMsgId].push({ id, text: replyText, createdAt: Date.now() });
  renderMessages();
  return id;
}

/* ------------- ë¡œë”© í‘œì‹œ ------------- */
function showLoadingUnderUser(userMsgId){
  loadingBubble = { id: uid('loading'), userId:userMsgId };
  const el = document.createElement('div');
  el.className = 'message bot';
  el.dataset.id = loadingBubble.id;
  el.innerHTML = `<div class="loading"><div>ìƒê° ì¤‘...</div><div class="dots"><span></span><span></span><span></span></div></div>`;
  messagesState.push({ id: loadingBubble.id, role:'bot', text:'', temp:true, sourceUserId:userMsgId });
  renderMessages();
}
function removeLoading(){
  if(!loadingBubble) return;
  const idx = messagesState.findIndex(m=>m.id===loadingBubble.id);
  if(idx>=0) messagesState.splice(idx,1);
  loadingBubble=null;
}

/* ------------- íŒŒì¼ ì²˜ë¦¬ UI ------------- */
const fileInput = document.getElementById('fileInput');
const attachmentsEl = document.getElementById('attachments');
let pendingFiles = []; // File objects

fileInput.addEventListener('change', e=>{
  const files = Array.from(e.target.files);
  for(const f of files){
    pendingFiles.push(f);
  }
  renderAttachments();
});
function renderAttachments(){
  attachmentsEl.innerHTML = '';
  pendingFiles.forEach((f,i)=>{
    const div = document.createElement('div'); div.className='attach-item';
    div.innerHTML = `<strong>${escapeHtml(f.name)}</strong><span style="opacity:.7">(${niceBytes(f.size)})</span>`;
    const removeBtn = document.createElement('button'); removeBtn.className='ctrl-btn'; removeBtn.style.marginLeft='8px'; removeBtn.innerText='ì œê±°';
    removeBtn.onclick = ()=>{ pendingFiles.splice(i,1); renderAttachments(); };
    div.appendChild(removeBtn);
    attachmentsEl.appendChild(div);
  });
}
function niceBytes(bytes){
  if(bytes<1024) return bytes+'B';
  const units=['KB','MB','GB','TB'];
  let u=-1; do{ bytes=bytes/1024; u++; } while(bytes>=1024 && u<units.length-1);
  return bytes.toFixed(bytes>=10?0:1)+units[u];
}

/* ------------- ì „ì†¡ ë¡œì§: í…ìŠ¤íŠ¸+íŒŒì¼ ------------- */
const sendBtn = document.getElementById('sendBtn');
const textarea = document.getElementById('userInput');

async function sendMessage(){
  const text = textarea.value.trim();
  if(!text && pendingFiles.length===0) return;
  // create attachments meta (local preview)
  const filesMeta = pendingFiles.map(f=>({ name:f.name, size:f.size, sizeHuman:niceBytes(f.size) }));
  const userMsgId = addUserMessage(text || '[íŒŒì¼ ì „ì†¡]', filesMeta);
  textarea.value = '';
  pendingFiles = []; renderAttachments();

  showLoadingUnderUser(userMsgId);

  try{
    // if there are files, send multipart/form-data; otherwise JSON
    let responseData = null;
    if(filesMeta.length>0){
      const fd = new FormData();
      fd.append('message', text);
      pendingFiles = []; // already copied to filesMeta; but original File objects were cleared above -> we need actual files. To fix: capture files before clearing.
      // NOTE: we need original Files â€” we captured them above as pendingFiles but then cleared them. Fix: store files before clearing.
    }
  } catch(e){
    // fallback: try JSON without files
    console.error(e);
  }

  // --- To avoid tricky file state bugs, we'll do the actual send with preserved files.
  await sendToBackendAndHandle(userMsgId, text, filesMeta);
}

async function sendToBackendAndHandle(userMsgId, text, filesMeta){
  // We need the actual File objects. We'll get them from the file input element's files (which were cleared if user removed).
  // To keep behavior robust: check fileInput.files.
  const actualFiles = Array.from(fileInput.files || []).slice(0); // may be empty
  // Build request
  try{
    let res;
    if(actualFiles.length>0){
      const fd = new FormData();
      fd.append('message', text);
      actualFiles.forEach((f,i)=> fd.append('file'+i, f));
      res = await fetch(BACKEND_FILE_URL, { method:'POST', body: fd });
    } else {
      res = await fetch(BACKEND_URL, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message:text })
      });
    }
    if(!res.ok){ throw new Error('Network error: '+res.status); }
    const data = await res.json();
    // assume backend returns { reply: "..." }
    removeLoading();
    addBotReply(userMsgId, data.reply || 'ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    // clear native file input
    fileInput.value='';
    renderAttachments();
  }catch(err){
    removeLoading();
    addBotReply(userMsgId, 'âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.message || err));
    console.error(err);
  }
}

/* ------------- ì‚¬ìš©ì ë©”ì‹œì§€ ìˆ˜ì • ------------- */
function startEditMessage(msgId){
  const msg = messagesState.find(m=>m.id===msgId && m.role==='user');
  if(!msg) return;
  // prefill textarea and focus
  textarea.value = msg.text;
  textarea.focus();
  // mark editing state
  textarea.dataset.editing = msgId;
  sendBtn.innerText = 'ìˆ˜ì •';
}
async function applyEdit(){
  const editId = textarea.dataset.editing;
  if(!editId) return;
  const newText = textarea.value.trim();
  if(!newText) return;
  // update the message
  const msgIdx = messagesState.findIndex(m=>m.id===editId && m.role==='user');
  if(msgIdx===-1) return;
  messagesState[msgIdx].text = newText;
  // delete all bot replies that are tied to this user message (but keep them in history)
  const removed = [];
  for(let i = messagesState.length-1; i>=0; i--){
    const m = messagesState[i];
    if(m.role==='bot' && m.sourceUserId === editId){
      removed.unshift(m); // keep order
      messagesState.splice(i,1);
    }
  }
  // save removed replies into replyHistory (already saved) â€” they are already there because replyHistory kept earlier replies.
  // After editing we send the edited message again and get new reply.
  renderMessages();
  // cleanup edit UI
  delete textarea.dataset.editing;
  sendBtn.innerText = 'â¤';
  // send to backend again
  showLoadingUnderUser(editId);
  await sendToBackendAndHandle(editId, newText, []);
}

/* ------------- Previous replies modal ------------- */
const prevModal = document.getElementById('prevModal'), prevContent = document.getElementById('prevContent'), closePrev = document.getElementById('closePrev');
closePrev.onclick = ()=> { prevModal.style.display='none'; prevContent.innerHTML=''; }
function showPreviousReplies(userMsgId){
  const hist = replyHistory[userMsgId] || [];
  prevContent.innerHTML = '';
  if(hist.length===0){ prevContent.innerHTML = '<div>ì´ì „ì— ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; prevModal.style.display='flex'; return; }
  hist.slice().reverse().forEach(h=>{
    const block = document.createElement('div'); block.style.borderBottom='1px solid var(--border)'; block.style.padding='8px 0';
    block.innerHTML = `<div style="font-size:13px;color:var(--muted);margin-bottom:6px;">${new Date(h.createdAt).toLocaleString()}</div><div>${escapeHtml(h.text).replace(/\n/g,'<br/>')}</div>`;
    prevContent.appendChild(block);
  });
  prevModal.style.display = 'flex';
}

/* ------------- ì´ë²¤íŠ¸ ë°”ì¸ë”© ------------- */
sendBtn.addEventListener('click', async ()=>{
  if(textarea.dataset.editing) await applyEdit(); else await sendMessage();
});

textarea.addEventListener('keydown', async (e)=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    if(textarea.dataset.editing) await applyEdit(); else await sendMessage();
  }
});

// suggestion cards click
document.querySelectorAll('.suggestion-card').forEach(c=>{
  c.onclick = ()=>{
    textarea.value = c.dataset.prompt;
    textarea.focus();
  };
});

// dark mode toggle
const darkBtn = document.getElementById('darkBtn'); darkBtn.onclick = ()=>{
  document.body.classList.toggle('dark');
  darkBtn.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
};

// support copy-of-message (ë³µì‚¬)
messagesEl.addEventListener('click', (e)=>{
  const t = e.target;
  if(t && t.classList && t.classList.contains('copy-btn')){
    // already handled in individual handler
  }
});

// close prev modal when clicking outside
prevModal.addEventListener('click', (ev)=>{ if(ev.target===prevModal) prevModal.style.display='none'; });

/* ------------- ì´ˆê¸° ë Œë”ë§ ------------- */
renderMessages();

/* ------------- ì£¼ì˜: íŒŒì¼ ì „ì†¡ ì•ˆì •ì„± ë³´ì™„ -------------
í˜„ì¬ ë¡œì§ì€ ì‹¤ì œ File ê°ì²´ë¥¼ fileInput.filesì—ì„œ ì½ì–´ ì „ì†¡í•©ë‹ˆë‹¤.
ë§Œì•½ ì‚¬ìš©ìê°€ ì²¨ë¶€ í›„ fileInputì„ ë¹„ìš°ë©´ íŒŒì¼ ì „ì†¡ì´ ì•ˆ ë©ë‹ˆë‹¤.
ì´ ë¶€ë¶„ì€ ë°±ì—”ë“œì™€ UI íë¦„ì— ë”°ë¼ ì„¸ë¶€ ì¡°ì •í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
---------------------------------------------------- */

</script>
</body>
</html>
