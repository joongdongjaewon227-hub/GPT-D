<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPT-J Clone Refined</title>
<style>
:root {
  --bg: #1a1a1a;
  --text: #e8eaed;
  --text-secondary: #9aa0a6;
  --input-bg: #2c2f33;
  --border: #3c4043;
  --button-bg: #8ab4f8;
  --button-text: #1a1a1a;
  --message-bg-user: #ffffff;
  --message-text-user: #000000;
  --message-bg-bot: #2e2e2e;
  --bar-color: #8ab4f8;
  --transition: 0.4s ease;
}

body.light {
  --bg: #ffffff;
  --text: #1f1f1f;
  --text-secondary: #5f6368;
  --input-bg: #f1f3f4;
  --border: #dadce0;
  --button-bg: #1a73e8;
  --button-text: #ffffff;
  --message-bg-user: #333333;
  --message-text-user: #ffffff;
  --message-bg-bot: #e8eaed;
  --bar-color: #1a73e8;
}

/* 공통 스타일 */
* {
  box-sizing: border-box;
  transition: background var(--transition), color var(--transition), border var(--transition);
}

body {
  margin: 0;
  font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* 네비게이션 */
nav {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 58px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 16px;
  z-index: 20;
}

nav .logo {
  font-weight: 600;
  font-size: 18px;
  color: var(--text);
}

#darkBtn {
  background: none;
  border: 1px solid var(--border);
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 14px;
  color: var(--text);
  cursor: pointer;
}
#darkBtn:hover {
  background: var(--input-bg);
}

/* 메인 */
main {
  flex: 1;
  padding: 58px 12px 0;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* 환영 텍스트 */
.welcome-section {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  transition: all 0.8s ease;
}
.welcome-text {
  font-size: 32px;
  font-weight: 700;
  background: linear-gradient(90deg, #2979ff, #81d4fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 200% 200%;
  animation: gradientFlow 4s ease infinite alternate;
  transition: all 0.8s ease;
}
@keyframes gradientFlow {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* 환영 텍스트가 왼쪽 상단으로 이동 */
.welcome-small {
  position: fixed;
  top: 60px;
  left: 16px;
  font-size: 16px !important;
  opacity: 0.6;
  z-index: 10;
  text-align: left;
}

/* 메시지 영역 */
.messages {
  display: none;
  flex-direction: column;
  width: 100%;
  max-width: 768px;
  padding: 12px 0;
  margin-bottom: 100px;
  gap: 16px;
}

/* 사용자 메시지 */
.message-row.user-row {
  display: flex;
  justify-content: flex-end;
  padding-right: 12px;
}
.message-row.bot-row {
  display: flex;
  justify-content: flex-start;
  padding-left: 12px;
}

/* 버블 둥글게 (4개 다) */
.message {
  border-radius: 20px;
  padding: 12px 16px;
  max-width: 70%;
  font-size: 15px;
  line-height: 1.5;
  border: 1px solid var(--border);
  word-break: break-word;
}

.message.user {
  background-color: var(--message-bg-user);
  color: var(--message-text-user);
}

.message.bot {
  background-color: var(--message-bg-bot);
  color: var(--text);
  opacity: 0;
  transform: scale(0.9);
  transform-origin: top left;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.message.bot.loaded {
  opacity: 1;
  transform: scale(1);
}

/* 로딩 인디케이터 */
.loading-indicator-row {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  padding-left: 16px;
}
.loading-indicator-bubble {
  width: 120px;
  height: 8px;
  background: var(--border);
  border-radius: 8px;
  overflow: hidden;
  position: relative;
}
.loading-bar {
  position: absolute;
  height: 100%;
  width: 40%;
  background: var(--bar-color);
  animation: moveBar 1.3s infinite linear;
}
@keyframes moveBar {
  0% { left: -40%; }
  100% { left: 100%; }
}

/* 입력 영역 */
.input-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: var(--bg);
  display: flex;
  justify-content: center;
  padding: 6px 16px 16px;
  z-index: 20;
}
.input-wrapper {
  display: flex;
  align-items: flex-end;
  width: 100%;
  max-width: 768px;
  background: var(--input-bg);
  border-radius: 24px;
  border: 1px solid var(--border);
  padding: 6px 12px;
  gap: 10px;
}
textarea {
  flex: 1;
  border: none;
  background: transparent;
  color: var(--text);
  font-size: 16px;
  resize: none;
  overflow-y: auto;
  min-height: 24px;
  max-height: 200px;
  padding: 8px 0;
  outline: none;
  font-family: inherit;
}
.btn.send {
  background: var(--button-bg);
  color: var(--button-text);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  border: none;
  font-size: 18px;
  cursor: pointer;
}
.btn.cancel {
  display: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  border: 1px solid var(--border);
  background: var(--input-bg);
  color: var(--text-secondary);
  cursor: pointer;
}
</style>
</head>

<body>
  <nav>
    <div class="logo">GPT-J</div>
    <button id="darkBtn">다크모드</button>
  </nav>

  <main id="main">
    <div class="welcome-section" id="welcome">
      <div class="welcome-text" id="welcomeText">안녕하세요, 반갑습니다!</div>
    </div>
    <div class="messages" id="messages"></div>
  </main>

  <div class="input-bar" id="inputBar">
    <div class="input-wrapper">
      <textarea id="userInput" placeholder="메시지를 입력하세요" rows="1"></textarea>
      <button class="btn send" id="sendBtn">➤</button>
      <button class="btn cancel" id="cancelBtn">❌</button>
    </div>
  </div>

<script>
const darkBtn = document.getElementById("darkBtn");
const body = document.body;
const welcome = document.getElementById("welcome");
const welcomeText = document.getElementById("welcomeText");
const messages = document.getElementById("messages");
const textarea = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const cancelBtn = document.getElementById("cancelBtn");

const BACKEND_URL = "https://jaewons0227.pythonanywhere.com/ask";
let abortController = null;
let isBotThinking = false;

darkBtn.addEventListener("click", () => {
  body.classList.toggle("light");
  darkBtn.textContent = body.classList.contains("light") ? "화이트모드" : "다크모드";
});

function renderMarkdown(text) {
  text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
  text = text.replace(/`([^`]+)`/g, "<code>$1</code>");
  text = text.replace(/\n/g, "<br>");
  return text;
}

function moveWelcomeUp() {
  welcomeText.classList.add("welcome-small");
  welcome.style.justifyContent = "flex-start";
}

function addMessage(role, text) {
  if (!welcomeText.classList.contains("welcome-small")) moveWelcomeUp();
  messages.style.display = "flex";

  const row = document.createElement("div");
  row.className = `message-row ${role}-row`;
  const msg = document.createElement("div");
  msg.className = `message ${role}`;
  msg.innerHTML = renderMarkdown(text);
  row.appendChild(msg);
  messages.appendChild(row);
  setTimeout(() => { if (role === "bot") msg.classList.add("loaded"); }, 10);
  messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });
}

function addLoadingIndicator() {
  const row = document.createElement("div");
  row.className = "loading-indicator-row";
  const bubble = document.createElement("div");
  bubble.className = "loading-indicator-bubble";
  const bar = document.createElement("div");
  bar.className = "loading-bar";
  bubble.appendChild(bar);
  row.appendChild(bubble);
  messages.appendChild(row);
  messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });
  return row;
}

function setThinkingState(thinking) {
  isBotThinking = thinking;
  sendBtn.style.display = thinking ? "none" : "inline-block";
  cancelBtn.style.display = thinking ? "inline-block" : "none";
  textarea.disabled = thinking;
}

async function sendMessage() {
  const text = textarea.value.trim();
  if (!text || isBotThinking) return;
  textarea.value = "";
  addMessage("user", text);
  const loader = addLoadingIndicator();
  setThinkingState(true);
  abortController = new AbortController();

  try {
    const res = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text }),
      signal: abortController.signal,
    });
    const data = await res.json();
    loader.remove();
    addMessage("bot", data.reply);
  } catch (err) {
    loader.remove();
    if (err.name !== "AbortError") addMessage("bot", "⚠️ 오류가 발생했습니다.");
  } finally {
    setThinkingState(false);
    abortController = null;
  }
}

sendBtn.addEventListener("click", sendMessage);
cancelBtn.addEventListener("click", () => abortController && abortController.abort());
textarea.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
</script>
</body>
</html>
